## 单点登录

单点登录(SingleSignOn，SSO)，就是通过用户的一次性鉴别登录，当用户在身份认证服务器上登录一次以后，即可获得访问单点登录系统中其他关联系统和应用软件的权限。

## CAS

Central Authentication Service 中央认证服务。

## 模块

### cas模块

认证模块，可以手机号密码登录，token获取用户信息。

### chat模块

聊天模块，有自己的用户体系，根据认证获取的id在查自己的用户。

### mall模块

商城模块，使用认证模块的用户。

## 功能

### 前端功能

1. 当用户在各自模块没有登录时，跳转到cas模块，并带上跳转之前的路径。
2. 跳转到cas后，查看当前LocalStorage是否存在token，若存在，验证没有过期后跳转回去，并带上token。若不存在，则跳到登录页面，登录成功之后跳转回去。
3. 跳转回之前模块后，将带过来的token存到LocalStorage中，下次调接口时先从本地查询token。

### 后端功能

1. cas模块负责登录及查询token的有效性。
2. 每个模块的请求，通过拦截器拦截去cas认证中心查询token有效性并获取用户信息。
3. mall模块没有自己的用户体系，通过认证之后的用户即该模块的用户。
4. chat模块有自己的用户体系，cas模块返回数据之后，还需要根据返回数据查询自己的用户信息。

## 可提升优化

### 前端

1. 页面跳转带着原地址的写法（已处理）。
2. 认证之后跳转回去token放在路径中，可能会不安全（已处理）。
3. LocalStorage中没有时间限制，可以根据业务场景，选择Cookie或者SessionStorage进行存储。

### 后端

1. 没有注册、登出功能，每个模块注册完用户之后都应将数据保存进cas模块，或者由cas模块统一完成注册功能。
2. token没有限制时长，现在是直接放在map里面，可以放在缓存中并指定缓存的失效时间及失效策略。
3. 拦截器可对某些接口放行，不一定所有请求都需要拦截。
4. 登录成功之后应返回token及token的失效时间。

## 升级

> 使用页面跳转的方式来处理cookie/webStorage共享的方式会使整个页面重新加载，这个现象不是我们想要的。

### 浏览器同源策略

只有同协议、同域名、同端口的Cookie、WebStorage数据可以共享，其它数据不能共享。

### 使用Cookie做SSO

1. 同域： 将sessionId保存在二级域名下即可。
2. 同父域： 将sessionId保存在顶级域名下即可。
3. 不同域：使用JSONP跨域请求及302临时重定向处理页面跳转问题。

### 使用WebStorage做SSO

使用PostMessage + iframe的方式来处理页面跳转问题。本项目使用此方式。

### Cookie 与 WebStorage

1. 如果将数据保存在Cookie中，发送请求时会将所有cookie带上，而WebStorage不会。
2. Cookie大小在1K左右，而WebStorage在3M左右。
3. 如果将Cookie的域名设置为顶级域名，那么其二级域名是都可以拿到的。而WebStorage只能拿到当前域名下的。

***END***
